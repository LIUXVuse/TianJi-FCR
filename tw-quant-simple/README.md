# 台股量化回測與訊號系統

一個完整的台股量化分析工具，從資料下載、技術指標、回測驗證到每日訊號提醒。

## 🌟 新功能提示

- ✅ **Web UI 介面** - 瀏覽器操作，無需終端指令
- ✅ **一鍵更新** - 自動下載股價、法人、融資融券資料
- ✅ **法人策略** - 外資/投信連買 3天/5天 多種選項
- ✅ **策略說明** - 每個策略顯示買入/賣出條件
- ✅ **交易明細** - 回測結果包含完整買賣記錄
- ✅ **回測時間範圍** - 可選擇開始/結束日期
- ✅ **策略監控** - 監控多股票策略訊號（12 種策略）
- ✅ **監控清單持久化** - 資料存在伺服器，換瀏覽器不會遺失
- ✅ **投組策略進階選項** - 鑽石手/停損停利後買回/多層次鑽石手

---

## 📦 功能總覽

| 功能 | 說明 | 使用方式 |
|------|------|---------|
| **🌐 Web UI** | 瀏覽器操作介面 | `python -m uvicorn web.app:app` |
| **訊號掃描** | 今日買入訊號 + 策略排名 | `python signal_scanner.py` |
| **夏普掃描** | 全市場策略回測排名 | `python scan_market.py` |
| **投組回測** | 多股資金池回測 | `python examples/portfolio_demo.py` |
| **參數優化** | 策略參數 Grid Search | `python backtest/optimizer.py` |
| **資料下載** | 下載/更新全市場股價與法人 | `python downloader_tw.py` |

---

## 🚀 快速開始

### 方法一：整合天機啟動（推薦）

本專案已整合至天機·火控雷達，只需一個指令：

```bash
# 在專案根目錄（天機·火控雷達）
npm run dev
```

這會同時啟動前端 (port 3000) 和量化後端 (port 8000)，訪問 `http://localhost:3000` 點選「量化」標籤即可使用。

### 方法二：獨立啟動

```bash
# 1. 安裝依賴
python -m venv .venv
source .venv/bin/activate  # Mac/Linux
pip install -r requirements.txt

# 2. 啟動 Web UI（區網可連）
python -m uvicorn web.app:app --host 0.0.0.0 --port 8000

# 3. 打開瀏覽器
open http://127.0.0.1:8000
```

### 方法三：命令列操作

```bash
# 1. 下載股價資料（首次約需 30 分鐘）
python downloader_tw.py

# 2. 下載法人歷史資料
python institutional.py 20240101 20241224

# 3. 計算技術指標
python indicators.py

# 4. 訊號掃描
python signal_scanner.py
```

---

## 🌐 Web UI 功能

啟動後訪問 <http://127.0.0.1:8000>

| 頁面 | 功能 |
|------|------|
| **📊 資料管理** | 一鍵更新股價/法人/融資融券，每日 19:00 自動更新 |
| **📈 個股回測** | 選擇股票和策略執行回測，支援時間範圍選擇 |
| **💼 投資組合** | 預設組合（科技三傑、四大金控、ETF三寶）或自訂 |
| **🎯 參數優化** | 自動測試多組均線參數找出最佳配置 |
| **🔍 全市場掃描** | 掃描全市場找出高夏普比率的股票 |
| **📡 策略監控** | 監控多支股票的策略訊號和交易歷史 |

---

## 📁 檔案結構

```
tw-quant-simple/
├── 🌐 Web UI (web/)
│   ├── app.py              # FastAPI 後端
│   └── static/index.html   # 前端介面
│
├── 🔧 主要工具 (根目錄)
│   ├── signal_scanner.py   # 訊號掃描器
│   ├── scan_market.py      # 全市場夏普掃描
│   ├── downloader_tw.py    # 股價下載
│   ├── institutional.py    # 法人資料下載
│   ├── margin.py           # 融資融券資料
│   └── indicators.py       # 技術指標計算
│
├── 📈 回測引擎 (backtest/)
│   ├── engine.py           # 回測核心
│   ├── strategy.py         # 12 種內建策略
│   ├── strategy_config.py  # 策略配置與說明
│   ├── strategy_portfolio.py # 投組策略
│   ├── optimizer.py        # 參數優化
│   ├── portfolio.py        # 投資組合回測
│   ├── metrics.py          # 績效指標
│   └── report.py           # HTML 報表
│
├── 📂 資料目錄 (data/)
│   ├── tw-share/dayK/      # 股價日K (2500+ 檔)
│   ├── institutional/      # 法人歷史資料
│   └── margin/             # 融資融券資料
│
└── 📄 報告 (reports/)
    ├── signal_alert.html   # 今日訊號
    └── portfolio_report.html # 投組報告
```

---

## 🎯 內建策略 (12 種)

### 技術分析策略 (8 種)

| 策略 | 買入條件 | 賣出條件 |
|------|---------|---------|
| MA5x20 | 5日均線上穿20日均線 | 5日均線下穿20日均線 |
| MA5x60 | 5日均線上穿60日均線 | 5日均線下穿60日均線 |
| RSI | RSI < 30 (超賣) | RSI > 70 (超買) |
| MACD | MACD線上穿信號線 | MACD線下穿信號線 |
| 動量突破 | 股價突破20日最高價 | 股價跌破20日最低價 |
| 海龜策略 | 股價突破55日最高價 | 股價跌破20日最低價 |
| 量價突破 | 成交量2倍+漲2% | 量縮+跌2% |
| 布林通道 | 股價碰下軌反彈 | 股價碰上軌回落 |

### 法人籌碼策略 (4 種)

| 策略 | 買入條件 | 賣出條件 |
|------|---------|---------|
| 外資連買 3天 | 外資連續買超 3 天 | 外資連續賣超 3 天 |
| 外資連買 5天 | 外資連續買超 5 天 | 外資連續賣超 5 天 |
| 投信連買 3天 | 投信連續買超 3 天 | 投信連續賣超 3 天 |
| 投信連買 5天 | 投信連續買超 5 天 | 投信連續賣超 5 天 |

---

## 📊 績效指標說明

| 指標 | 說明 | 好的標準 |
|------|------|----------|
| **夏普比率** | 報酬/風險 | > 1 好, > 2 很好 |
| **總報酬率** | 總獲利% | 越高越好 |
| **最大回撤** | 最大虧損% | 越小越好 (< -20%) |
| **勝率** | 獲利交易% | > 50% |
| **盈虧比** | 平均獲利/虧損 | > 1.5 |

---

## ⚙️ 交易成本設定

符合台灣證交所規定：

- 手續費：0.1425%（買賣都收）
- 證交稅：0.3%（賣出時收）
- 滑價：0.1%（模擬真實成交）

---

## 🔄 每日工作流程

### 使用 Web UI（推薦）

1. 打開瀏覽器 <http://127.0.0.1:8000>
2. 點「一鍵更新」→ 等待完成
3. 到「個股回測」或「全市場掃描」查看結果

### 使用命令列

```bash
# 每日盤後
python downloader_tw.py      # 更新股價
python institutional.py auto # 更新法人
python indicators.py         # 計算指標
python signal_scanner.py     # 掃描訊號
```

---

## 📦 依賴套件

```
pandas>=1.5.0
numpy>=1.24.0
yfinance>=0.2.28
requests>=2.28.0
tqdm>=4.64.0
lxml>=4.9.0
fastapi>=0.100.0
uvicorn>=0.23.0
apscheduler>=3.10.0
```

---

## 📈 關於股價數據

### 調整後價格 (Adjusted Price)

本系統使用 Yahoo Finance (yfinance) 下載股價數據，**預設返回「調整後價格」**。

| 項目 | 說明 |
|------|------|
| **什麼是調整後價格？** | Yahoo Finance 會根據配息、股票分割等事件，回溯調整所有歷史價格 |
| **為什麼價格與盤面不同？** | 因為歷史價格已經「扣除」了配息影響，所以數值會比實際盤面低 |
| **適合什麼用途？** | ✅ 回測策略、計算長期報酬率、技術指標分析 |

### 為什麼使用調整後價格？

1. **長期報酬計算更準確** - 已包含配息再投資的效果
2. **避免假訊號** - 除息日不會產生跳空，技術指標更平滑
3. **策略回測更真實** - 反映真實的總報酬率（含配息）

### 如何比對實際價格？

如需與券商軟體價格比對，可查詢 Yahoo Finance 原始網頁：

- 範例：<https://finance.yahoo.com/quote/0050.TW>

---

## ⚠️ 風險提醒

- 訊號僅供參考，不構成投資建議
- 過去績效不保證未來報酬
- 請自行評估風險，謹慎投資
