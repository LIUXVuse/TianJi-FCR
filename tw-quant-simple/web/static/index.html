<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡é‡åŒ–åˆ†æç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 180px;
            height: 100vh;
            background: #161b22;
            border-right: 1px solid #30363d;
            padding: 20px 0;
        }

        .logo {
            padding: 0 15px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #58a6ff;
            border-bottom: 1px solid #30363d;
        }

        .nav-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-item:hover {
            background: #21262d;
        }

        .nav-item.active {
            background: #21262d;
            border-left: 3px solid #58a6ff;
        }

        /* ä¸»å…§å®¹ */
        .main {
            margin-left: 180px;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å¡ç‰‡ */
        .card {
            background: #161b22;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #30363d;
        }

        .card h3 {
            color: #58a6ff;
            margin-bottom: 12px;
            font-size: 15px;
        }

        /* æŒ‰éˆ• */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #238636;
            color: white;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .btn-primary:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 15px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* é–‹é—œ */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle {
            width: 44px;
            height: 24px;
            background: #484f58;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.on {
            background: #238636;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }

        .toggle.on::after {
            left: 22px;
        }

        /* æ—¥èªŒ */
        .log-list {
            max-height: 180px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }

        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid #21262d;
            display: flex;
            gap: 8px;
        }

        .log-time {
            color: #8b949e;
        }

        .log-success {
            color: #3fb950;
        }

        .log-error {
            color: #f85149;
        }

        /* é€²åº¦æ¢ */
        .progress-bar {
            height: 6px;
            background: #21262d;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #238636;
            transition: width 0.3s;
        }

        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }

        th {
            background: #21262d;
            color: #58a6ff;
            font-weight: 600;
        }

        tr:hover {
            background: #1f2937;
        }

        /* è¡¨å–® */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #8b949e;
            font-size: 13px;
        }

        select,
        input {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #21262d;
            color: #c9d1d9;
            font-size: 13px;
            min-width: 180px;
        }

        input[type="text"] {
            width: 100%;
            max-width: 300px;
        }

        /* æŒ‡æ¨™å¡ç‰‡ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .metric-card {
            background: #21262d;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .metric-value {
            font-size: 20px;
            font-weight: bold;
            color: #58a6ff;
        }

        .metric-label {
            font-size: 11px;
            color: #8b949e;
            margin-top: 4px;
        }

        .positive {
            color: #3fb950 !important;
        }

        .negative {
            color: #f85149 !important;
        }

        /* ç‹€æ…‹ */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            max-width: 100%;
            word-break: break-all;
            line-height: 1.4;
        }

        .status-running {
            background: #1f6feb;
            color: white;
        }

        .status-idle {
            background: #21262d;
            color: #8b949e;
        }

        .last-update {
            color: #8b949e;
            font-size: 12px;
            margin-left: auto;
        }

        .header-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        /* å¤šé¸æ¨™ç±¤ */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .tag {
            background: #21262d;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag .remove {
            cursor: pointer;
            color: #f85149;
            font-weight: bold;
        }

        .stock-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* è‡ªè¨‚ç¢ºèªå°è©±æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-box {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            text-align: center;
        }

        .modal-box h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
        }

        .modal-box p {
            color: #8b949e;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons .btn {
            min-width: 80px;
        }
    </style>
</head>

<body>
    <!-- è‡ªè¨‚ç¢ºèªå°è©±æ¡† -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <h3 id="confirm-title">ç¢ºèª</h3>
            <p id="confirm-message">ç¢ºå®šè¦åŸ·è¡Œé€™å€‹æ“ä½œå—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="confirmCancel()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmOk()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="logo">ğŸ“Š å°è‚¡é‡åŒ–ç³»çµ±</div>
        <div class="nav-item active" data-page="data">ğŸ“¥ è³‡æ–™ç®¡ç†</div>
        <div class="nav-item" data-page="signals">ğŸ“Š ä»Šæ—¥è¨Šè™Ÿ</div>
        <div class="nav-item" data-page="scan">ğŸ” å…¨å¸‚å ´æƒæ</div>
        <div class="nav-item" data-page="portfolio">ğŸ’¼ æŠ•è³‡çµ„åˆ</div>
        <div class="nav-item" data-page="optimize">ğŸ¯ åƒæ•¸å„ªåŒ–</div>
        <div class="nav-item" data-page="backtest">ğŸ“ˆ å€‹è‚¡å›æ¸¬</div>
        <div class="nav-item" data-page="monitor">ğŸ“¡ ç­–ç•¥ç›£æ§</div>
    </div>

    <!-- ä¸»å…§å®¹ -->
    <div class="main">
        <!-- ========== è³‡æ–™ç®¡ç†é  ========== -->
        <div class="page active" id="page-data">
            <div class="header-bar">
                <h1 class="page-title">ğŸ“¥ è³‡æ–™ç®¡ç†</h1>
                <span class="last-update" id="last-update">æœ€å¾Œæ›´æ–°: --</span>
            </div>

            <div class="card">
                <h3>ğŸ“¦ ä¸€éµæ›´æ–°ï¼ˆæ¨è–¦ï¼‰</h3>
                <button class="btn btn-primary btn-large" onclick="downloadAll()">
                    ğŸš€ ä¸€éµæ›´æ–°å…¨éƒ¨è³‡æ–™
                </button>
                <p style="margin-top: 8px; font-size: 12px; color: #8b949e;">
                    è‡ªå‹•åŸ·è¡Œï¼šè‚¡åƒ¹ â†’ æ³•äºº â†’ èè³‡èåˆ¸ â†’ æŒ‡æ¨™ â†’ è¨Šè™Ÿæƒæ
                </p>
                <div class="progress-bar" id="progress-bar" style="display: none;">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ”§ æ‰‹å‹•åˆ†æ­¥ä¸‹è¼‰</h3>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="downloadPrice()">ğŸ“¥ è‚¡åƒ¹</button>
                    <button class="btn btn-secondary" onclick="downloadInstitutional()">ğŸ“¥ æ³•äºº</button>
                    <button class="btn btn-secondary" onclick="downloadMargin()">ğŸ“¥ èè³‡èåˆ¸</button>
                    <button class="btn btn-secondary" onclick="calculateIndicators()">ğŸ“Š æŒ‡æ¨™</button>
                    <button class="btn btn-secondary" onclick="scanSignals()">ğŸ” æƒæ</button>
                </div>
                <div style="margin-top: 8px;">
                    <span class="status-badge status-idle" id="task-status">ç©ºé–’ä¸­</span>
                </div>
            </div>

            <div class="card">
                <h3>â° è‡ªå‹•æ’ç¨‹</h3>
                <div class="toggle-wrapper">
                    <span>æ¯æ—¥ 19:00 è‡ªå‹•åŸ·è¡Œ</span>
                    <div class="toggle" id="scheduler-toggle" onclick="toggleScheduler()"></div>
                    <span id="scheduler-status">å·²é—œé–‰</span>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“‹ åŸ·è¡Œæ—¥èªŒ</h3>
                <div class="log-list" id="log-list"></div>
            </div>
        </div>

        <!-- ========== ä»Šæ—¥è¨Šè™Ÿé  ========== -->
        <div class="page" id="page-signals">
            <h1 class="page-title">ğŸ“Š ä»Šæ—¥è¨Šè™Ÿ</h1>
            <div class="card">
                <p>ä»Šæ—¥å¤§æ¨å€‹è‚¡ + ç­–ç•¥æ•ˆæœæ’å</p>
                <a href="/api/signals/today" target="_blank" class="btn btn-primary"
                    style="display: inline-block; margin-top: 10px; text-decoration: none;">
                    ğŸ“„ é–‹å•Ÿè¨Šè™Ÿå ±å‘Š
                </a>
            </div>
        </div>

        <!-- ========== å…¨å¸‚å ´æƒæé  ========== -->
        <div class="page" id="page-scan">
            <h1 class="page-title">ğŸ” å…¨å¸‚å ´æƒæ</h1>
            <div class="card">
                <h3>âš ï¸ æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€è¦ 30-60 åˆ†é˜</h3>
                <p style="margin-bottom: 10px; color: #8b949e;">
                    æœƒå°å…¨å¸‚å ´ 2600+ è‚¡ç¥¨é€²è¡Œå›æ¸¬ï¼Œæ‰¾å‡ºå„ç­–ç•¥å¤æ™®æ¯”ç‡ TOP 30
                </p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runMarketScan()">ğŸš€ åŸ·è¡Œå…¨å¸‚å ´æƒæ</button>
                    <a href="/reports/market_scan_all_strategies.html" target="_blank" class="btn btn-secondary"
                        style="text-decoration: none;">
                        ğŸ“„ æŸ¥çœ‹ç¾æœ‰å ±å‘Š
                    </a>
                </div>
                <div id="scan-status" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- ========== å€‹è‚¡å›æ¸¬é  ========== -->
        <div class="page" id="page-backtest">
            <h1 class="page-title">ğŸ“ˆ å€‹è‚¡å›æ¸¬</h1>

            <!-- å¿«é€Ÿå›æ¸¬ -->
            <div class="card">
                <h3>âš¡ å¿«é€Ÿå›æ¸¬</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group">
                        <label>è‚¡ç¥¨ä»£ç¢¼ï¼ˆåªéœ€è¼¸å…¥æ•¸å­—ï¼‰</label>
                        <input type="text" id="backtest-ticker" placeholder="ä¾‹: 2330" value="2330"
                            style="width: 120px;">
                    </div>
                    <div class="form-group">
                        <label>åˆå§‹è³‡é‡‘ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="backtest-capital" value="500000" min="10000" step="10000"
                            style="width: 120px;" placeholder="ä¾‹: 500000">
                    </div>
                    <div class="form-group">
                        <label>ç­–ç•¥</label>
                        <select id="backtest-strategy" onchange="toggleCustomMA()">
                            <optgroup label="ğŸ“Š æŠ€è¡“åˆ†æç­–ç•¥">
                                <option value="MA5x20">MA5x20 å‡ç·šäº¤å‰</option>
                                <option value="MA5x60">MA5x60 ä¸­æœŸå‡ç·š</option>
                                <option value="MA_Custom">ğŸ”§ è‡ªè¨‚å‡ç·š</option>
                                <option value="MACD">MACD å‹•èƒ½</option>
                                <option value="RSI">RSI è¶…è²·è¶…è³£</option>
                                <option value="å¸ƒæ—é€šé“">å¸ƒæ—é€šé“</option>
                                <option value="å‹•é‡çªç ´">å‹•é‡çªç ´</option>
                                <option value="é‡åƒ¹çªç ´">é‡åƒ¹çªç ´</option>
                                <option value="æµ·é¾œç­–ç•¥">æµ·é¾œç­–ç•¥</option>
                            </optgroup>
                            <optgroup label="ğŸ¢ æ³•äººç±Œç¢¼ç­–ç•¥">
                                <option value="å¤–è³‡é€£è²·3å¤©">å¤–è³‡é€£è²· 3å¤©</option>
                                <option value="å¤–è³‡é€£è²·5å¤©">å¤–è³‡é€£è²· 5å¤©</option>
                                <option value="æŠ•ä¿¡é€£è²·3å¤©">æŠ•ä¿¡é€£è²· 3å¤©</option>
                                <option value="æŠ•ä¿¡é€£è²·5å¤©">æŠ•ä¿¡é€£è²· 5å¤©</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- è‡ªè¨‚å‡ç·šåƒæ•¸ï¼ˆé è¨­éš±è—ï¼‰ -->
                    <div class="form-group" id="custom-ma-params" style="display: none;">
                        <label>çŸ­æœŸMA</label>
                        <input type="number" id="backtest-short-ma" value="10" min="2" max="100" style="width: 60px;">
                        <label style="margin-left: 10px;">é•·æœŸMA</label>
                        <input type="number" id="backtest-long-ma" value="40" min="5" max="500" style="width: 60px;">
                    </div>
                    <!-- å›æ¸¬æ™‚é–“ç¯„åœ -->
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="backtest-start-date" value="2024-01-01" style="width: 140px;">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="date" id="backtest-end-date" style="width: 140px;">
                    </div>
                    <button class="btn btn-primary" onclick="runBacktest()">ğŸš€ åŸ·è¡Œå›æ¸¬</button>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #8b949e;">
                    ğŸ’¡ è‡ªå‹•è£œä¸Š .TW å¾Œç¶´ï¼Œä¹Ÿæ”¯æ´ç›´æ¥è¼¸å…¥ 2330.TW æˆ– 6739.TWO
                </p>
            </div>

            <!-- å›æ¸¬çµæœ -->
            <div class="card" id="backtest-result" style="display: none;">
                <h3>ğŸ“Š å›æ¸¬çµæœ - <span id="result-ticker"></span></h3>

                <!-- ç­–ç•¥èªªæ˜ -->
                <div id="strategy-info"
                    style="margin-bottom: 15px; padding: 12px; background: #21262d; border-radius: 8px;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div><strong>ğŸ“¥ è²·å…¥æ¢ä»¶ï¼š</strong><span id="strategy-entry"></span></div>
                        <div><strong>ğŸ“¤ è³£å‡ºæ¢ä»¶ï¼š</strong><span id="strategy-exit"></span></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #8b949e;">
                        <span id="strategy-type"></span> | é¢¨éšªç­‰ç´š: <span id="strategy-risk"></span>
                    </div>
                </div>

                <!-- ç¸¾æ•ˆæŒ‡æ¨™ -->
                <div class="metrics-grid" id="backtest-metrics"></div>

                <!-- äº¤æ˜“æ˜ç´° -->
                <div id="trades-section" style="margin-top: 15px;">
                    <h4>ğŸ“‹ äº¤æ˜“æ˜ç´°ï¼ˆæœ€è¿‘ 30 ç­†ï¼‰</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table id="trades-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>é¡å‹</th>
                                    <th>åƒ¹æ ¼</th>
                                    <th>è‚¡æ•¸</th>
                                    <th>æç›Š</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ‰¹æ¬¡å›æ¸¬ -->
            <div class="card">
                <h3>ğŸ“‹ æ‰¹æ¬¡å›æ¸¬ï¼ˆå¤šè‚¡æ¯”è¼ƒï¼‰</h3>
                <div class="form-group">
                    <label>è¼¸å…¥å¤šå€‹è‚¡ç¥¨ä»£ç¢¼ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼Œåªéœ€è¼¸å…¥æ•¸å­—ï¼‰</label>
                    <input type="text" id="batch-tickers" placeholder="ä¾‹: 2330, 2317, 2454, 2881, 0050"
                        style="width: 100%; max-width: 400px;">
                </div>
                <button class="btn btn-secondary" onclick="runBatchBacktest()">æ‰¹æ¬¡å›æ¸¬</button>

                <div id="batch-result" style="margin-top: 15px; display: none;">
                    <table id="batch-table">
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨</th>
                                <th>ç­–ç•¥</th>
                                <th>å¤æ™®</th>
                                <th>å ±é…¬ç‡</th>
                                <th>å›æ’¤</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ç†±é–€è‚¡ç¥¨å¿«æ· -->
            <div class="card">
                <h3>ğŸ”¥ ç†±é–€è‚¡ç¥¨å¿«æ·</h3>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="setTicker('2330')">å°ç©é›»</button>
                    <button class="btn btn-secondary" onclick="setTicker('2317')">é´»æµ·</button>
                    <button class="btn btn-secondary" onclick="setTicker('2454')">è¯ç™¼ç§‘</button>
                    <button class="btn btn-secondary" onclick="setTicker('2881')">å¯Œé‚¦é‡‘</button>
                    <button class="btn btn-secondary" onclick="setTicker('0050')">å…ƒå¤§50</button>
                    <button class="btn btn-secondary" onclick="setTicker('0056')">é«˜è‚¡æ¯</button>
                    <button class="btn btn-secondary" onclick="setTicker('00878')">æ°¸çºŒé«˜æ¯</button>
                </div>
            </div>
        </div>

        <!-- ========== æŠ•è³‡çµ„åˆé  ========== -->
        <div class="page" id="page-portfolio">
            <h1 class="page-title">ğŸ’¼ æŠ•è³‡çµ„åˆå›æ¸¬</h1>

            <!-- å¿«é€Ÿçµ„åˆ -->
            <div class="card">
                <h3>âš¡ å¿«é€Ÿé–‹å§‹</h3>
                <p style="margin-bottom: 10px; color: #8b949e;">é¸æ“‡é è¨­çµ„åˆæˆ–è‡ªè¨‚è‚¡ç¥¨</p>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="setPortfolio('2330,2317,2454')">ğŸ”§ ç§‘æŠ€ä¸‰å‚‘</button>
                    <button class="btn btn-secondary" onclick="setPortfolio('2881,2882,2883,2884')">ğŸ¦ å››å¤§é‡‘æ§</button>
                    <button class="btn btn-secondary" onclick="setPortfolio('0050,0056,00878')">ğŸ“Š ETFä¸‰å¯¶</button>
                    <button class="btn btn-secondary" onclick="setPortfolio('2330,2317,2454,2881,2882')">â­ æ¬Šå€¼äº”è™</button>
                </div>
            </div>

            <!-- è‡ªè¨‚çµ„åˆ -->
            <div class="card">
                <h3>ğŸ”§ è‡ªè¨‚çµ„åˆ</h3>
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£ç¢¼ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼Œåªéœ€è¼¸å…¥æ•¸å­—ï¼Œæœ€å¤š 10 æª”ï¼‰</label>
                    <input type="text" id="portfolio-tickers" placeholder="ä¾‹: 2330, 2317, 2454, 2881"
                        style="width: 100%; max-width: 500px;" value="2330, 2317, 2454">
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group">
                        <label>åˆå§‹è³‡é‡‘ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="portfolio-capital" value="1000000" min="10000" step="10000"
                            style="width: 120px;" placeholder="ä¾‹: 1000000">
                    </div>
                    <div class="form-group">
                        <label>ç­–ç•¥é¸æ“‡</label>
                        <select id="portfolio-strategy" onchange="updateStrategyParams()">
                            <option value="equal_weight">ğŸ“Š ç­‰æ¬Šé‡ (æ¯æœˆå†å¹³è¡¡)</option>
                            <option value="buy_hold">ğŸ’ è²·å…¥æŒæœ‰</option>
                            <option value="dca">ğŸ“… å®šæœŸå®šé¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="portfolio-start-date" value="2024-01-01" style="width: 140px;">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="date" id="portfolio-end-date" style="width: 140px;">
                    </div>
                    <button class="btn btn-primary" id="portfolio-btn" onclick="runPortfolio()">ğŸš€ åŸ·è¡ŒæŠ•çµ„å›æ¸¬</button>
                </div>

                <!-- ç­–ç•¥åƒæ•¸ (å‹•æ…‹é¡¯ç¤º) -->
                <div id="strategy-params" style="margin-top: 12px; display: none;">
                    <!-- ç­‰æ¬Šé‡åƒæ•¸ -->
                    <div id="equal-weight-params" style="display: none;">
                        <div class="form-group">
                            <label>å†å¹³è¡¡é »ç‡</label>
                            <select id="rebalance-freq" style="width: 120px;">
                                <option value="weekly">æ¯é€±ï¼ˆé€±ä¸€ï¼‰</option>
                                <option value="monthly" selected>æ¯æœˆï¼ˆæœˆåˆï¼‰</option>
                                <option value="quarterly">æ¯å­£ï¼ˆå­£åˆï¼‰</option>
                            </select>
                        </div>
                        <p style="font-size: 11px; color: #8b949e; margin-top: 4px;">ğŸ“Š æ¯åˆ°æŒ‡å®šé€±æœŸï¼Œå°‡æŒè‚¡åƒ¹å€¼é‡æ–°åˆ†é…æˆç­‰æ¬Šé‡</p>
                    </div>

                    <!-- è²·å…¥æŒæœ‰åƒæ•¸ -->
                    <div id="buy-hold-params" style="display: none;">
                        <div class="form-group">
                            <label>æŒæœ‰æ¨¡å¼</label>
                            <select id="buy-hold-mode" onchange="updateBuyHoldMode()" style="width: 280px;">
                                <option value="diamond">ğŸ’ é‘½çŸ³æ‰‹ï¼ˆæ°¸ä¸è³£å‡ºï¼‰</option>
                                <option value="rebuy">ğŸ”„ åœæåœåˆ©å¾Œè²·å›</option>
                                <option value="multilayer">ğŸ“ˆ å¤šå±¤æ¬¡é‘½çŸ³æ‰‹ï¼ˆè‡ªè¨‚åŠ ç¢¼ï¼‰</option>
                            </select>
                        </div>

                        <!-- åœæåœåˆ©è¨­å®šï¼ˆé‘½çŸ³æ‰‹æ¨¡å¼ä¸é¡¯ç¤ºï¼‰ -->
                        <div id="stop-params" style="display: none;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div class="form-group">
                                    <label>åœæ (%)</label>
                                    <input type="number" id="stop-loss" value="-10" min="-50" max="0" step="1"
                                        style="width: 80px;">
                                </div>
                                <div class="form-group">
                                    <label>åœåˆ© (%)</label>
                                    <input type="number" id="take-profit" value="30" min="0" max="200" step="5"
                                        style="width: 80px;">
                                </div>
                            </div>
                        </div>

                        <!-- åœæåœåˆ©å¾Œè²·å›çš„é¡å¤–è¨­å®š -->
                        <div id="rebuy-params" style="display: none;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div class="form-group">
                                    <label>å†·éœæœŸï¼ˆå¤©ï¼‰</label>
                                    <input type="number" id="cooldown-days" value="30" min="1" max="365"
                                        style="width: 80px;">
                                </div>
                                <div class="form-group">
                                    <label>è²·å›é‡‘é¡</label>
                                    <select id="rebuy-amount" style="width: 120px;">
                                        <option value="all">å…¨éƒ¨è³‡é‡‘</option>
                                        <option value="original">åŸå§‹æŠ•å…¥é‡‘é¡</option>
                                    </select>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: #8b949e; margin-top: 4px;">ğŸ”„ é”åˆ°åœæåœåˆ©å¾Œè³£å‡ºï¼Œç­‰å¾…å†·éœæœŸå¾Œè‡ªå‹•è²·å›</p>
                        </div>

                        <!-- å¤šå±¤æ¬¡é‘½çŸ³æ‰‹åŠ ç¢¼æ™‚é–“è¡¨ -->
                        <div id="multilayer-params" style="display: none;">
                            <p style="font-size: 12px; color: #58a6ff; margin-bottom: 8px;">ğŸ“ˆ
                                åˆå§‹è³‡é‡‘æœƒå…ˆè²·å…¥ï¼Œä¹‹å¾Œä¾ä¸‹åˆ—æ™‚é–“è¡¨åŠ ç¢¼ï¼ˆè‹¥ç„¡é–‹ç›¤è‡ªå‹•é †å»¶ï¼‰</p>
                            <div id="extra-buys-list"></div>
                            <div style="display: flex; gap: 10px; margin-top: 8px;">
                                <input type="date" id="extra-buy-date" style="width: 140px;">
                                <input type="number" id="extra-buy-amount" placeholder="é‡‘é¡" min="1000" step="1000"
                                    style="width: 100px;">
                                <button class="btn btn-secondary" onclick="addExtraBuy()" style="padding: 4px 12px;">â•
                                    æ–°å¢</button>
                            </div>
                        </div>

                        <p id="buy-hold-hint" style="font-size: 11px; color: #8b949e; margin-top: 8px;">ğŸ’ æ°¸é æŒæœ‰ï¼Œä¸ç®¡æ¼²è·Œéƒ½ä¸è³£å‡º
                        </p>
                    </div>

                    <!-- å®šæœŸå®šé¡åƒæ•¸ -->
                    <div id="dca-params" style="display: none;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div class="form-group">
                                <label>æ¯æœˆæŠ•å…¥é‡‘é¡ (å…ƒ)</label>
                                <input type="number" id="dca-amount" value="10000" min="1000" step="1000"
                                    style="width: 120px;" placeholder="ä¾‹: 10000">
                            </div>
                            <div class="form-group">
                                <label>æ¯æœˆè²·å…¥æ—¥</label>
                                <select id="dca-day" style="width: 80px;">
                                    <option value="1">1 æ—¥</option>
                                    <option value="5">5 æ—¥</option>
                                    <option value="10">10 æ—¥</option>
                                    <option value="15">15 æ—¥</option>
                                    <option value="20">20 æ—¥</option>
                                </select>
                            </div>
                        </div>
                        <p style="font-size: 11px; color: #8b949e; margin-top: 4px;">ğŸ“… åˆå§‹è³‡é‡‘æœƒä¸€æ¬¡è²·å…¥ï¼Œä¹‹å¾Œæ¯æœˆå›ºå®šæŠ•å…¥ä¸Šè¿°é‡‘é¡ï¼ˆè‹¥ç„¡é–‹ç›¤è‡ªå‹•é †å»¶ï¼‰
                        </p>
                    </div>
                </div>

                <div id="portfolio-status" style="margin-top: 8px;"></div>
            </div>

            <!-- å›æ¸¬çµæœ -->
            <div class="card" id="portfolio-result" style="display: none;">
                <h3>ğŸ“Š æŠ•çµ„å›æ¸¬çµæœ</h3>
                <div id="portfolio-info" style="margin-bottom: 15px;"></div>
                <div class="metrics-grid" id="portfolio-metrics"></div>
            </div>

            <!-- æ­·å²å ±å‘Š -->
            <div class="card">
                <h3>ğŸ“‚ æ­·å²å ±å‘Šç®¡ç†</h3>
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="loadReports('portfolio')">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
                <div id="portfolio-reports-list" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #8b949e;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ========== åƒæ•¸å„ªåŒ–é  ========== -->
        <div class="page" id="page-optimize">
            <h1 class="page-title">ğŸ¯ å‡ç·šç­–ç•¥åƒæ•¸å„ªåŒ–</h1>

            <!-- èªªæ˜ -->
            <div class="card">
                <h3>ğŸ’¡ åŠŸèƒ½èªªæ˜</h3>
                <p style="color: #8b949e;">
                    è‡ªå‹•æ¸¬è©¦å¤šçµ„å‡ç·šäº¤å‰åƒæ•¸çµ„åˆï¼Œæ‰¾å‡ºæ­·å²è¡¨ç¾æœ€ä½³çš„çŸ­æœŸ/é•·æœŸå‡ç·šé…ç½®ã€‚
                </p>
            </div>

            <!-- åƒæ•¸è¨­å®š -->
            <div class="card">
                <h3>âš™ï¸ åƒæ•¸è¨­å®š</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group">
                        <label>è‚¡ç¥¨ä»£ç¢¼ï¼ˆåªéœ€è¼¸å…¥æ•¸å­—ï¼‰</label>
                        <input type="text" id="opt-ticker" placeholder="ä¾‹: 2330" value="2330" style="width: 120px;">
                    </div>
                    <div class="form-group">
                        <label>åˆå§‹è³‡é‡‘ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="opt-capital" value="500000" min="10000" step="10000"
                            style="width: 120px;" placeholder="ä¾‹: 500000">
                    </div>
                    <div class="form-group">
                        <label>çŸ­æœŸå‡ç·šï¼ˆå¤©ï¼‰</label>
                        <select id="opt-short-preset">
                            <option value="3,5,7,10">å¿«é€Ÿ (3-10)</option>
                            <option value="5,10,15,20" selected>æ¨™æº– (5-20)</option>
                            <option value="10,15,20,30">ç©©å¥ (10-30)</option>
                            <option value="custom">è‡ªè¨‚...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é•·æœŸå‡ç·šï¼ˆå¤©ï¼‰</label>
                        <select id="opt-long-preset">
                            <option value="20,30,40,60">ä¸­æœŸ (20-60)</option>
                            <option value="20,40,60,120" selected>æ¨™æº– (20-120)</option>
                            <option value="60,120,180,240">é•·æœŸ (60-240)</option>
                            <option value="custom">è‡ªè¨‚...</option>
                        </select>
                    </div>
                </div>

                <!-- è‡ªè¨‚è¼¸å…¥ï¼ˆé è¨­éš±è—ï¼‰ -->
                <div id="custom-params" style="display: none; margin-top: 15px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group">
                            <label>è‡ªè¨‚çŸ­æœŸï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="opt-short" value="5,10,15,20" style="width: 180px;">
                        </div>
                        <div class="form-group">
                            <label>è‡ªè¨‚é•·æœŸï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="opt-long" value="20,40,60,120" style="width: 180px;">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="runOptimize()">ğŸš€ é–‹å§‹å„ªåŒ–</button>
                </div>
            </div>

            <!-- ç†±é–€è‚¡ç¥¨å¿«æ· -->
            <div class="card">
                <h3>ğŸ”¥ ç†±é–€è‚¡ç¥¨å¿«æ·</h3>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="setOptTicker('2330')">å°ç©é›»</button>
                    <button class="btn btn-secondary" onclick="setOptTicker('2317')">é´»æµ·</button>
                    <button class="btn btn-secondary" onclick="setOptTicker('2454')">è¯ç™¼ç§‘</button>
                    <button class="btn btn-secondary" onclick="setOptTicker('0050')">å…ƒå¤§50</button>
                    <button class="btn btn-secondary" onclick="setOptTicker('0056')">é«˜è‚¡æ¯</button>
                </div>
            </div>

            <!-- å„ªåŒ–çµæœ -->
            <div class="card" id="opt-result" style="display: none;">
                <h3>ğŸ† æœ€ä½³åƒæ•¸</h3>
                <div id="opt-best"></div>

                <h3 style="margin-top: 15px;">ğŸ“Š å…¨éƒ¨çµ„åˆæ’å</h3>
                <table id="opt-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>çŸ­æœŸMA</th>
                            <th>é•·æœŸMA</th>
                            <th>å¤æ™®æ¯”ç‡</th>
                            <th>å ±é…¬ç‡</th>
                            <th>äº¤æ˜“æ¬¡æ•¸</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ========== ç­–ç•¥ç›£æ§é  ========== -->
        <div class="page" id="page-monitor">
            <h1 class="page-title">ğŸ“¡ ç­–ç•¥ç›£æ§</h1>

            <div class="card">
                <h3>ğŸ”§ æ–°å¢ç›£æ§</h3>
                <p style="margin-bottom: 10px; color: #8b949e;">é¸æ“‡è‚¡ç¥¨å’Œç­–ç•¥ä¾†ç›£æ§äº¤æ˜“è¨Šè™Ÿ</p>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group">
                        <label>è‚¡ç¥¨ä»£ç¢¼</label>
                        <input type="text" id="monitor-ticker" placeholder="ä¾‹: 2330" style="width: 100px;">
                    </div>
                    <div class="form-group">
                        <label>ç­–ç•¥</label>
                        <select id="monitor-strategy" onchange="toggleMonitorCustomMA()">
                            <optgroup label="ğŸ“Š æŠ€è¡“åˆ†æç­–ç•¥">
                                <option value="MA5x20">MA5x20 å‡ç·šäº¤å‰</option>
                                <option value="MA5x60">MA5x60 ä¸­æœŸå‡ç·š</option>
                                <option value="MA_Custom">ğŸ”§ è‡ªè¨‚å‡ç·š</option>
                                <option value="MACD">MACD å‹•èƒ½</option>
                                <option value="RSI">RSI è¶…è²·è¶…è³£</option>
                                <option value="å¸ƒæ—é€šé“">å¸ƒæ—é€šé“</option>
                                <option value="å‹•é‡çªç ´">å‹•é‡çªç ´</option>
                                <option value="é‡åƒ¹çªç ´">é‡åƒ¹çªç ´</option>
                                <option value="æµ·é¾œç­–ç•¥">æµ·é¾œç­–ç•¥</option>
                            </optgroup>
                            <optgroup label="ğŸ¢ æ³•äººç±Œç¢¼ç­–ç•¥">
                                <option value="å¤–è³‡é€£è²·3å¤©">å¤–è³‡é€£è²· 3å¤©</option>
                                <option value="å¤–è³‡é€£è²·5å¤©">å¤–è³‡é€£è²· 5å¤©</option>
                                <option value="æŠ•ä¿¡é€£è²·3å¤©">æŠ•ä¿¡é€£è²· 3å¤©</option>
                                <option value="æŠ•ä¿¡é€£è²·5å¤©">æŠ•ä¿¡é€£è²· 5å¤©</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- è‡ªè¨‚å‡ç·šåƒæ•¸ï¼ˆé è¨­éš±è—ï¼‰ -->
                    <div class="form-group" id="monitor-custom-ma-params" style="display: none;">
                        <label>çŸ­æœŸMA</label>
                        <input type="number" id="monitor-short-ma" value="10" min="2" max="100" style="width: 60px;">
                        <label style="margin-left: 10px;">é•·æœŸMA</label>
                        <input type="number" id="monitor-long-ma" value="40" min="5" max="500" style="width: 60px;">
                    </div>
                    <button class="btn btn-primary" onclick="addMonitor()">â• æ·»åŠ ç›£æ§</button>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“‹ ç›£æ§æ¸…å–®</h3>
                <div id="monitor-list">
                    <p style="color: #8b949e; text-align: center; padding: 20px;">
                        å°šç„¡ç›£æ§é …ç›®ï¼Œè«‹æ·»åŠ è‚¡ç¥¨å’Œç­–ç•¥
                    </p>
                </div>
            </div>

            <!-- äº¤æ˜“æ­·å²è©³æƒ…ï¼ˆå½ˆå‡ºè¦–çª—ï¼‰ -->
            <div class="card" id="monitor-detail" style="display: none;">
                <h3>ğŸ“œ äº¤æ˜“æ­·å² - <span id="detail-ticker"></span> (<span id="detail-strategy"></span>)</h3>
                <div id="detail-trades"></div>
            </div>
        </div>
    </div>

    <script>
        // é é¢åˆ‡æ›
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById('page-' + item.dataset.page).classList.add('active');
            });
        });

        // è‡ªè¨‚ç¢ºèªå°è©±æ¡†ï¼ˆè§£æ±º Chrome é–ƒé€€å•é¡Œï¼‰
        let confirmCallback = null;

        function showConfirm(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-modal').classList.add('show');
            confirmCallback = onConfirm;
        }

        function confirmOk() {
            document.getElementById('confirm-modal').classList.remove('show');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        }

        function confirmCancel() {
            document.getElementById('confirm-modal').classList.remove('show');
            confirmCallback = null;
        }

        // API å‘¼å«
        async function api(path, method = 'GET', body = null) {
            const options = { method };
            if (body) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(body);
            }
            const res = await fetch(path, options);
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'è«‹æ±‚å¤±æ•—');
            }
            return res.json();
        }

        // æ›´æ–°ç‹€æ…‹
        async function updateStatus() {
            try {
                const data = await api('/api/status');

                document.getElementById('last-update').textContent =
                    'æœ€å¾Œæ›´æ–°: ' + (data.last_update || '--');

                // æ’ç¨‹
                const toggle = document.getElementById('scheduler-toggle');
                const status = document.getElementById('scheduler-status');
                if (data.scheduler_enabled) {
                    toggle.classList.add('on');
                    status.textContent = 'å·²é–‹å•Ÿ';
                } else {
                    toggle.classList.remove('on');
                    status.textContent = 'å·²é—œé–‰';
                }

                // ä»»å‹™ç‹€æ…‹
                const taskStatus = document.getElementById('task-status');
                const progressBar = document.getElementById('progress-bar');
                const progressFill = document.getElementById('progress-fill');

                if (data.running_task) {
                    let statusText = 'åŸ·è¡Œä¸­: ' + data.running_task;
                    if (data.current_step) {
                        statusText += ' | ' + data.current_step;
                    }
                    taskStatus.textContent = statusText;
                    taskStatus.className = 'status-badge status-running';

                    if (data.task_progress > 0) {
                        progressBar.style.display = 'block';
                        progressFill.style.width = data.task_progress + '%';
                    } else {
                        progressBar.style.display = 'block';
                        progressFill.style.width = '5%';  // è‡³å°‘é¡¯ç¤ºä¸€é»é€²åº¦
                    }
                } else {
                    taskStatus.textContent = 'ç©ºé–’ä¸­';
                    taskStatus.className = 'status-badge status-idle';
                    progressBar.style.display = 'none';
                }

                // æ—¥èªŒ
                document.getElementById('log-list').innerHTML = data.logs.map(log => `
                    <div class="log-item">
                        <span class="log-time">${log.time}</span>
                        <span class="${log.level === 'success' ? 'log-success' : log.level === 'error' ? 'log-error' : ''}">${log.message}</span>
                    </div>
                `).join('');

            } catch (e) {
                console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—', e);
            }
        }

        // ä¸‹è¼‰åŠŸèƒ½
        async function downloadAll() {
            await api('/api/download/all', 'POST');
            updateStatus();
        }

        async function downloadPrice() {
            await api('/api/download/price', 'POST');
            updateStatus();
        }

        async function downloadInstitutional() {
            await api('/api/download/institutional', 'POST');
            updateStatus();
        }

        async function downloadMargin() {
            await api('/api/download/margin', 'POST');
            updateStatus();
        }

        async function calculateIndicators() {
            await api('/api/download/indicators', 'POST');
            updateStatus();
        }

        async function scanSignals() {
            await api('/api/scan/signals', 'POST');
            updateStatus();
        }

        function runMarketScan() {
            showConfirm('ğŸ” å…¨å¸‚å ´æƒæ', 'å…¨å¸‚å ´æƒæéœ€è¦ 30-60 åˆ†é˜ï¼Œç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ', async function () {
                const statusEl = document.getElementById('scan-status');
                statusEl.innerHTML = '<span class="status-badge status-running">â³ æ­£åœ¨å•Ÿå‹•æƒæ...</span>';

                try {
                    const data = await api('/api/scan/market', 'POST');
                    statusEl.innerHTML = '<span class="status-badge status-running">â³ æ­£åœ¨åŸ·è¡Œä¸­ï¼Œè«‹æŸ¥çœ‹åŸ·è¡Œæ—¥èªŒ...</span>';
                    updateStatus();
                } catch (e) {
                    console.error('å…¨å¸‚å ´æƒæå¤±æ•—:', e);
                    statusEl.innerHTML = `<span class="status-badge status-error">âŒ åŸ·è¡Œå¤±æ•—: ${e.message || 'æœªçŸ¥éŒ¯èª¤'}</span>`;
                }
            });
        }

        async function toggleScheduler() {
            await api('/api/scheduler/toggle', 'POST');
            updateStatus();
        }

        // å›æ¸¬ - è‡ªè¨‚å‡ç·šåƒæ•¸åˆ‡æ›
        function toggleCustomMA() {
            const strategy = document.getElementById('backtest-strategy').value;
            const customParams = document.getElementById('custom-ma-params');
            customParams.style.display = strategy === 'MA_Custom' ? 'flex' : 'none';
        }

        function setTicker(code) {
            document.getElementById('backtest-ticker').value = code;
        }

        async function runBacktest() {
            const ticker = document.getElementById('backtest-ticker').value.trim();
            const strategy = document.getElementById('backtest-strategy').value;
            const capital = parseInt(document.getElementById('backtest-capital').value) || 500000;

            // è‡ªè¨‚å‡ç·šåƒæ•¸
            const short_period = strategy === 'MA_Custom'
                ? parseInt(document.getElementById('backtest-short-ma').value) || 10
                : null;
            const long_period = strategy === 'MA_Custom'
                ? parseInt(document.getElementById('backtest-long-ma').value) || 40
                : null;

            // æ™‚é–“ç¯„åœåƒæ•¸ï¼ˆç©ºå€¼è¡¨ç¤ºä½¿ç”¨å…¨éƒ¨æ•¸æ“šï¼‰
            const start_date = document.getElementById('backtest-start-date').value || null;
            const end_date = document.getElementById('backtest-end-date').value || null;

            if (!ticker) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }

            // é©—è­‰è‡ªè¨‚åƒæ•¸
            if (strategy === 'MA_Custom' && short_period >= long_period) {
                alert('çŸ­æœŸå‡ç·šå¤©æ•¸å¿…é ˆå°æ–¼é•·æœŸå‡ç·šå¤©æ•¸');
                return;
            }

            try {
                const data = await api('/api/backtest/single', 'POST', {
                    ticker, strategy, capital, short_period, long_period, start_date, end_date
                });

                document.getElementById('backtest-result').style.display = 'block';
                // è‡ªè¨‚å‡ç·šé¡¯ç¤º MA{çŸ­}x{é•·}ï¼Œå…¶ä»–ç­–ç•¥ç…§å¸¸é¡¯ç¤º
                const strategyLabel = strategy === 'MA_Custom'
                    ? `MA${short_period}x${long_period}`
                    : strategy;
                document.getElementById('result-ticker').textContent = data.ticker + ' (' + strategyLabel + ')';

                // é¡¯ç¤ºç­–ç•¥èªªæ˜
                if (data.strategy_info) {
                    document.getElementById('strategy-entry').textContent = data.strategy_info.entry || 'æœªå®šç¾©';
                    document.getElementById('strategy-exit').textContent = data.strategy_info.exit || 'æœªå®šç¾©';
                    document.getElementById('strategy-type').textContent = data.strategy_info.type || '';
                    document.getElementById('strategy-risk').textContent = data.strategy_info.risk || '';
                }

                // é¡¯ç¤ºç¸¾æ•ˆæŒ‡æ¨™
                document.getElementById('backtest-metrics').innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value ${data.metrics.total_return >= 0 ? 'positive' : 'negative'}">${data.metrics.total_return}%</div>
                        <div class="metric-label">ç¸½å ±é…¬ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.metrics.sharpe_ratio}</div>
                        <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value negative">${data.metrics.max_drawdown}%</div>
                        <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.metrics.win_rate}%</div>
                        <div class="metric-label">å‹ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.metrics.trade_count}</div>
                        <div class="metric-label">äº¤æ˜“æ¬¡æ•¸</div>
                    </div>
                `;

                // é¡¯ç¤ºäº¤æ˜“æ˜ç´°
                const tradesBody = document.querySelector('#trades-table tbody');
                if (data.trades && data.trades.length > 0) {
                    tradesBody.innerHTML = data.trades.map(t => `
                        <tr>
                            <td>${t.date}</td>
                            <td class="${t.type === 'BUY' ? 'positive' : 'negative'}">${t.type === 'BUY' ? 'ğŸŸ¢ è²·å…¥' : 'ğŸ”´ è³£å‡º'}</td>
                            <td>$${t.price}</td>
                            <td>${t.shares}</td>
                            <td class="${(t.profit || 0) >= 0 ? 'positive' : 'negative'}">${t.profit !== null ? '$' + t.profit : '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tradesBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ç„¡äº¤æ˜“è¨˜éŒ„</td></tr>';
                }
            } catch (e) {
                alert('å›æ¸¬å¤±æ•—: ' + e.message);
            }
        }

        // æ‰¹æ¬¡å›æ¸¬
        async function runBatchBacktest() {
            const input = document.getElementById('batch-tickers').value.trim();
            const strategy = document.getElementById('backtest-strategy').value;
            const capital = parseInt(document.getElementById('backtest-capital').value) || 500000;

            if (!input) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }

            const tickers = input.split(',').map(t => t.trim()).filter(t => t);

            try {
                const data = await api('/api/backtest/batch', 'POST', { tickers, strategy, capital });

                document.getElementById('batch-result').style.display = 'block';
                document.querySelector('#batch-table tbody').innerHTML = data.results.map(r => `
                    <tr>
                        <td>${r.ticker}</td>
                        <td>${r.strategy}</td>
                        <td>${r.metrics.sharpe_ratio}</td>
                        <td class="${r.metrics.total_return >= 0 ? 'positive' : 'negative'}">${r.metrics.total_return}%</td>
                        <td>${r.metrics.max_drawdown}%</td>
                    </tr>
                `).join('');
            } catch (e) {
                alert('æ‰¹æ¬¡å›æ¸¬å¤±æ•—: ' + e.message);
            }
        }

        // æŠ•çµ„å›æ¸¬ - è¼”åŠ©å‡½æ•¸
        function setPortfolio(codes) {
            document.getElementById('portfolio-tickers').value = codes;
        }

        // ç­–ç•¥åƒæ•¸åˆ‡æ›
        // åŠ ç¢¼æ™‚é–“è¡¨è³‡æ–™
        let extraBuys = [];

        function updateStrategyParams() {
            const strategy = document.getElementById('portfolio-strategy').value;
            const paramsDiv = document.getElementById('strategy-params');
            const equalWeightParams = document.getElementById('equal-weight-params');
            const buyHoldParams = document.getElementById('buy-hold-params');
            const dcaParams = document.getElementById('dca-params');

            // éš±è—æ‰€æœ‰åƒæ•¸
            equalWeightParams.style.display = 'none';
            buyHoldParams.style.display = 'none';
            dcaParams.style.display = 'none';

            if (strategy === 'equal_weight') {
                paramsDiv.style.display = 'block';
                equalWeightParams.style.display = 'block';
            } else if (strategy === 'buy_hold') {
                paramsDiv.style.display = 'block';
                buyHoldParams.style.display = 'block';
                updateBuyHoldMode();
            } else if (strategy === 'dca') {
                paramsDiv.style.display = 'block';
                dcaParams.style.display = 'block';
            } else {
                paramsDiv.style.display = 'none';
            }
        }

        function updateBuyHoldMode() {
            const mode = document.getElementById('buy-hold-mode').value;
            const stopParams = document.getElementById('stop-params');
            const rebuyParams = document.getElementById('rebuy-params');
            const multilayerParams = document.getElementById('multilayer-params');
            const hint = document.getElementById('buy-hold-hint');

            // éš±è—æ‰€æœ‰
            stopParams.style.display = 'none';
            rebuyParams.style.display = 'none';
            multilayerParams.style.display = 'none';

            if (mode === 'diamond') {
                hint.textContent = 'ğŸ’ æ°¸é æŒæœ‰ï¼Œä¸ç®¡æ¼²è·Œéƒ½ä¸è³£å‡º';
            } else if (mode === 'rebuy') {
                stopParams.style.display = 'block';
                rebuyParams.style.display = 'block';
                hint.textContent = 'ğŸ”„ é”åˆ°åœæåœåˆ©å¾Œè³£å‡ºï¼Œå†·éœæœŸå¾Œè‡ªå‹•è²·å›';
            } else if (mode === 'multilayer') {
                multilayerParams.style.display = 'block';
                hint.textContent = 'ğŸ“ˆ æ°¸é æŒæœ‰ + ä¾æ™‚é–“è¡¨åŠ ç¢¼';
            }
        }

        function addExtraBuy() {
            const dateInput = document.getElementById('extra-buy-date');
            const amountInput = document.getElementById('extra-buy-amount');
            const date = dateInput.value;
            const amount = parseFloat(amountInput.value);

            if (!date || !amount || amount < 1000) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œé‡‘é¡ï¼ˆè‡³å°‘ 1000 å…ƒï¼‰');
                return;
            }

            extraBuys.push({ date, amount });
            extraBuys.sort((a, b) => a.date.localeCompare(b.date));
            renderExtraBuysList();

            // æ¸…ç©ºè¼¸å…¥
            dateInput.value = '';
            amountInput.value = '';
        }

        function removeExtraBuy(index) {
            extraBuys.splice(index, 1);
            renderExtraBuysList();
        }

        function renderExtraBuysList() {
            const listEl = document.getElementById('extra-buys-list');
            if (extraBuys.length === 0) {
                listEl.innerHTML = '<p style="color: #8b949e; font-size: 11px;">å°šæœªæ–°å¢åŠ ç¢¼è¨ˆç•«</p>';
                return;
            }
            listEl.innerHTML = extraBuys.map((item, i) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 4px 0; border-bottom: 1px solid #30363d;">
                    <span style="color: #58a6ff;">${item.date}</span>
                    <span style="color: #3fb950;">$${item.amount.toLocaleString()}</span>
                    <button class="btn btn-secondary" onclick="removeExtraBuy(${i})" style="padding: 2px 8px; font-size: 10px;">âœ•</button>
                </div>
            `).join('');
        }

        async function runPortfolio() {
            const input = document.getElementById('portfolio-tickers').value.trim();
            const capital = parseFloat(document.getElementById('portfolio-capital').value) || 1000000;
            const strategy = document.getElementById('portfolio-strategy').value;
            const statusEl = document.getElementById('portfolio-status');
            const btn = document.getElementById('portfolio-btn');

            if (!input) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }

            const tickers = input.split(',').map(t => t.trim()).filter(t => t);

            // å»ºç«‹è«‹æ±‚è³‡æ–™
            const requestData = {
                tickers,
                initial_capital: capital,
                strategy: strategy
            };

            // åŠ å…¥æ—¥æœŸåƒæ•¸
            const startDate = document.getElementById('portfolio-start-date').value;
            const endDate = document.getElementById('portfolio-end-date').value;
            if (startDate) requestData.start_date = startDate;
            if (endDate) requestData.end_date = endDate;

            // åŠ å…¥ç­–ç•¥åƒæ•¸
            if (strategy === 'equal_weight') {
                requestData.rebalance_freq = document.getElementById('rebalance-freq').value;
            } else if (strategy === 'buy_hold') {
                const mode = document.getElementById('buy-hold-mode').value;
                requestData.buy_hold_mode = mode;

                if (mode === 'rebuy') {
                    // åœæåœåˆ©å¾Œè²·å›æ¨¡å¼
                    const stopLoss = parseFloat(document.getElementById('stop-loss').value) / 100;
                    const takeProfit = parseFloat(document.getElementById('take-profit').value) / 100;
                    if (stopLoss) requestData.stop_loss = stopLoss;
                    if (takeProfit) requestData.take_profit = takeProfit;
                    requestData.cooldown_days = parseInt(document.getElementById('cooldown-days').value) || 30;
                    requestData.rebuy_amount = document.getElementById('rebuy-amount').value;
                } else if (mode === 'multilayer') {
                    // å¤šå±¤æ¬¡é‘½çŸ³æ‰‹æ¨¡å¼
                    requestData.extra_buys = extraBuys;
                }
                // diamond æ¨¡å¼ä¸éœ€è¦é¡å¤–åƒæ•¸
            } else if (strategy === 'dca') {
                requestData.dca_day = parseInt(document.getElementById('dca-day').value) || 1;
                requestData.dca_amount = parseFloat(document.getElementById('dca-amount').value) || 10000;
            }

            // é¡¯ç¤º loading ç‹€æ…‹
            statusEl.innerHTML = '<span class="status-badge status-running">â³ æ­£åœ¨åŸ·è¡Œå›æ¸¬...</span>';
            btn.disabled = true;

            try {
                const data = await api('/api/portfolio/run', 'POST', requestData);

                statusEl.innerHTML = '<span class="status-badge status-success">âœ… å›æ¸¬å®Œæˆ</span>';
                document.getElementById('portfolio-result').style.display = 'block';
                document.getElementById('portfolio-info').innerHTML = `
                    <p>ğŸ“¦ è‚¡ç¥¨çµ„åˆ: <strong>${data.tickers.join(', ')}</strong></p>
                    <p>ğŸ“ˆ ä½¿ç”¨ç­–ç•¥: <strong>${data.strategy}</strong></p>
                    <p>ğŸ’° åˆå§‹è³‡é‡‘: <strong>$${capital.toLocaleString()}</strong> â†’ æœ€çµ‚å¸‚å€¼: <strong>$${data.final_value.toLocaleString()}</strong></p>
                    ${data.report_url ? `<p><a href="${data.report_url}" target="_blank" class="btn btn-secondary" style="text-decoration:none; margin-top:8px;">ğŸ“„ æŸ¥çœ‹å®Œæ•´å ±å‘Š</a></p>` : ''}
                `;
                document.getElementById('portfolio-metrics').innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value ${data.metrics.total_return >= 0 ? 'positive' : 'negative'}">${data.metrics.total_return}%</div>
                        <div class="metric-label">ç¸½å ±é…¬ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.metrics.sharpe_ratio}</div>
                        <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value negative">${data.metrics.max_drawdown}%</div>
                        <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.metrics.trade_count}</div>
                        <div class="metric-label">äº¤æ˜“æ¬¡æ•¸</div>
                    </div>
                `;

                // é‡æ–°è¼‰å…¥å ±å‘Šåˆ—è¡¨
                loadReports('portfolio');
            } catch (e) {
                console.error('æŠ•çµ„å›æ¸¬å¤±æ•—:', e);
                statusEl.innerHTML = `<span class="status-badge status-error">âŒ å›æ¸¬å¤±æ•—: ${e.message || 'æœªçŸ¥éŒ¯èª¤'}</span>`;
            } finally {
                btn.disabled = false;
            }
        }

        // å ±å‘Šç®¡ç†
        async function loadReports(type = null) {
            const listEl = document.getElementById('portfolio-reports-list');
            if (!listEl) return;

            try {
                const url = type ? `/api/reports?report_type=${type}` : '/api/reports';
                const data = await api(url, 'GET');

                if (data.reports.length === 0) {
                    listEl.innerHTML = '<p style="color: #8b949e;">æš«ç„¡å ±å‘Š</p>';
                    return;
                }

                listEl.innerHTML = data.reports.map(r => {
                    const date = new Date(r.modified * 1000);
                    const dateStr = date.toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #30363d;">
                            <div>
                                <span>${r.icon}</span>
                                <a href="${r.url}" target="_blank" style="color: #58a6ff; text-decoration: none;">${r.filename}</a>
                                <span style="color: #8b949e; font-size: 11px; margin-left: 8px;">${dateStr}</span>
                            </div>
                            <button onclick="deleteReport('${r.filename}')" class="btn btn-secondary" style="padding: 2px 8px; font-size: 11px;">ğŸ—‘ï¸</button>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                listEl.innerHTML = `<p style="color: #f85149;">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        }

        function deleteReport(filename) {
            showConfirm('ğŸ—‘ï¸ åˆªé™¤å ±å‘Š', `ç¢ºå®šè¦åˆªé™¤ ${filename} å—ï¼Ÿ`, async function () {
                try {
                    await api(`/api/reports/${filename}`, 'DELETE');
                    loadReports('portfolio');
                } catch (e) {
                    console.error('åˆªé™¤å ±å‘Šå¤±æ•—:', e);
                    // ä½¿ç”¨éé˜»å¡æ–¹å¼é¡¯ç¤ºéŒ¯èª¤
                    const listEl = document.getElementById('portfolio-reports-list');
                    if (listEl) {
                        const errorDiv = document.createElement('div');
                        errorDiv.innerHTML = `<p style="color: #f85149; padding: 8px;">âŒ åˆªé™¤å¤±æ•—: ${e.message}</p>`;
                        listEl.insertBefore(errorDiv, listEl.firstChild);
                        setTimeout(() => errorDiv.remove(), 3000);
                    }
                }
            });
        }

        // å„ªåŒ– - è¼”åŠ©å‡½æ•¸
        function setOptTicker(code) {
            document.getElementById('opt-ticker').value = code;
        }

        // é¡¯ç¤º/éš±è—è‡ªè¨‚åƒæ•¸è¼¸å…¥
        document.getElementById('opt-short-preset')?.addEventListener('change', function () {
            toggleCustomParams();
        });
        document.getElementById('opt-long-preset')?.addEventListener('change', function () {
            toggleCustomParams();
        });

        function toggleCustomParams() {
            const shortVal = document.getElementById('opt-short-preset')?.value;
            const longVal = document.getElementById('opt-long-preset')?.value;
            const customDiv = document.getElementById('custom-params');
            if (customDiv) {
                customDiv.style.display = (shortVal === 'custom' || longVal === 'custom') ? 'block' : 'none';
            }
        }

        async function runOptimize() {
            const ticker = document.getElementById('opt-ticker').value.trim();

            // å¾ä¸‹æ‹‰é¸å–®æˆ–è‡ªè¨‚è¼¸å…¥å–å¾—åƒæ•¸
            const shortPreset = document.getElementById('opt-short-preset').value;
            const longPreset = document.getElementById('opt-long-preset').value;

            let shortRange, longRange;
            if (shortPreset === 'custom') {
                shortRange = document.getElementById('opt-short').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            } else {
                shortRange = shortPreset.split(',').map(s => parseInt(s.trim()));
            }
            if (longPreset === 'custom') {
                longRange = document.getElementById('opt-long').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            } else {
                longRange = longPreset.split(',').map(s => parseInt(s.trim()));
            }

            if (!ticker) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }
            if (shortRange.length === 0 || longRange.length === 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒæ•¸ç¯„åœ'); return; }

            try {
                const data = await api('/api/optimize', 'POST', {
                    ticker,
                    short_range: shortRange,
                    long_range: longRange
                });

                document.getElementById('opt-result').style.display = 'block';

                const best = data.best_params;
                document.getElementById('opt-best').innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${best.short_period}</div>
                            <div class="metric-label">æœ€ä½³çŸ­æœŸMA</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${best.long_period}</div>
                            <div class="metric-label">æœ€ä½³é•·æœŸMA</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${best.sharpe_ratio?.toFixed(2)}</div>
                            <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value ${best.total_return >= 0 ? 'positive' : 'negative'}">${(best.total_return * 100).toFixed(1)}%</div>
                            <div class="metric-label">å ±é…¬ç‡</div>
                        </div>
                    </div>
                `;

                document.querySelector('#opt-table tbody').innerHTML = data.all_results.map((r, i) => `
                    <tr>
                        <td>#${i + 1}</td>
                        <td>${r.short_period}</td>
                        <td>${r.long_period}</td>
                        <td>${r.sharpe_ratio?.toFixed(2)}</td>
                        <td class="${r.total_return >= 0 ? 'positive' : 'negative'}">${(r.total_return * 100).toFixed(1)}%</td>
                        <td>${r.total_trades || 0}</td>
                    </tr>
                `).join('');

            } catch (e) {
                alert('å„ªåŒ–å¤±æ•—: ' + e.message);
            }
        }

        // ========== ç­–ç•¥ç›£æ§åŠŸèƒ½ ==========
        let monitorList = [];

        // å¾ä¼ºæœå™¨è¼‰å…¥ç›£æ§æ¸…å–®
        async function loadMonitorList() {
            try {
                const data = await api('/api/monitor/list', 'GET');
                monitorList = data.list || [];
                renderMonitorList();
            } catch (e) {
                console.error('è¼‰å…¥ç›£æ§æ¸…å–®å¤±æ•—:', e);
                monitorList = [];
            }
        }

        // å„²å­˜ç›£æ§æ¸…å–®åˆ°ä¼ºæœå™¨
        async function saveMonitorList() {
            try {
                await api('/api/monitor/list', 'POST', { list: monitorList });
            } catch (e) {
                console.error('å„²å­˜ç›£æ§æ¸…å–®å¤±æ•—:', e);
            }
        }

        function renderMonitorList() {
            const container = document.getElementById('monitor-list');
            if (monitorList.length === 0) {
                container.innerHTML = `<p style="color: #8b949e; text-align: center; padding: 20px;">
                    å°šç„¡ç›£æ§é …ç›®ï¼Œè«‹æ·»åŠ è‚¡ç¥¨å’Œç­–ç•¥
                </p>`;
                return;
            }

            container.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨</th>
                            <th>ç­–ç•¥</th>
                            <th>ç•¶å‰è¨Šè™Ÿ</th>
                            <th>æœ€å¾Œæ›´æ–°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${monitorList.map((item, idx) => `
                            <tr>
                                <td><strong>${item.ticker}</strong></td>
                                <td>${item.strategy}</td>
                                <td id="signal-${idx}"><span class="status-badge status-idle">--</span></td>
                                <td id="update-${idx}">--</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="viewTrades(${idx})" style="padding: 4px 8px; font-size: 12px;">ğŸ“œ æ­·å²</button>
                                    <button class="btn btn-secondary" onclick="removeMonitor(${idx})" style="padding: 4px 8px; font-size: 12px;">âŒ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            // è‡ªå‹•æ›´æ–°è¨Šè™Ÿç‹€æ…‹
            updateAllMonitorSignals();
        }

        // ç­–ç•¥ç›£æ§ - è‡ªè¨‚å‡ç·šåˆ‡æ›
        function toggleMonitorCustomMA() {
            const strategy = document.getElementById('monitor-strategy').value;
            const customParams = document.getElementById('monitor-custom-ma-params');
            customParams.style.display = strategy === 'MA_Custom' ? 'flex' : 'none';
        }

        function addMonitor() {
            const ticker = document.getElementById('monitor-ticker').value.trim();
            let strategy = document.getElementById('monitor-strategy').value;
            if (!ticker) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }

            // è‡ªè¨‚å‡ç·šè™•ç†
            let short_period = null;
            let long_period = null;
            if (strategy === 'MA_Custom') {
                short_period = parseInt(document.getElementById('monitor-short-ma').value) || 10;
                long_period = parseInt(document.getElementById('monitor-long-ma').value) || 40;
                if (short_period >= long_period) {
                    alert('çŸ­æœŸå‡ç·šå¤©æ•¸å¿…é ˆå°æ–¼é•·æœŸå‡ç·šå¤©æ•¸');
                    return;
                }
                strategy = `MA${short_period}x${long_period}`;
            }

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = monitorList.some(m => m.ticker === ticker && m.strategy === strategy);
            if (exists) { alert('æ­¤ç›£æ§é …ç›®å·²å­˜åœ¨'); return; }

            monitorList.push({ ticker, strategy, short_period, long_period });
            saveMonitorList();  // å„²å­˜åˆ°ä¼ºæœå™¨
            document.getElementById('monitor-ticker').value = '';
            renderMonitorList();
        }

        function removeMonitor(idx) {
            monitorList.splice(idx, 1);
            saveMonitorList();  // å„²å­˜åˆ°ä¼ºæœå™¨
            renderMonitorList();
        }

        async function updateAllMonitorSignals() {
            for (let i = 0; i < monitorList.length; i++) {
                try {
                    const item = monitorList[i];
                    const data = await api('/api/monitor/signal', 'POST', {
                        ticker: item.ticker,
                        strategy: item.strategy,
                        short_period: item.short_period,
                        long_period: item.long_period
                    });

                    const signalEl = document.getElementById(`signal-${i}`);
                    const updateEl = document.getElementById(`update-${i}`);

                    if (data.signal === 1) {
                        signalEl.innerHTML = '<span class="status-badge status-success">ğŸŸ¢ è²·å…¥è¨Šè™Ÿ</span>';
                    } else if (data.signal === -1) {
                        signalEl.innerHTML = '<span class="status-badge status-error">ğŸ”´ è³£å‡ºè¨Šè™Ÿ</span>';
                    } else {
                        signalEl.innerHTML = '<span class="status-badge status-idle">âšª è§€æœ›ä¸­</span>';
                    }
                    updateEl.textContent = data.last_date || '--';
                } catch (e) {
                    console.error('æ›´æ–°è¨Šè™Ÿå¤±æ•—:', e);
                }
            }
        }

        async function viewTrades(idx) {
            const item = monitorList[idx];
            try {
                const data = await api('/api/monitor/trades', 'POST', {
                    ticker: item.ticker,
                    strategy: item.strategy,
                    short_period: item.short_period,
                    long_period: item.long_period
                });

                document.getElementById('detail-ticker').textContent = item.ticker;
                document.getElementById('detail-strategy').textContent = item.strategy;

                if (data.trades && data.trades.length > 0) {
                    document.getElementById('detail-trades').innerHTML = `
                        <table style="width: 100%;">
                            <thead>
                                <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>åƒ¹æ ¼</th><th>æŒæœ‰å¤©æ•¸</th><th>å ±é…¬</th></tr>
                            </thead>
                            <tbody>
                                ${data.trades.map(t => `
                                    <tr>
                                        <td>${t.date}</td>
                                        <td>${t.type === 'buy' ? 'ğŸŸ¢ è²·å…¥' : 'ğŸ”´ è³£å‡º'}</td>
                                        <td>${t.price?.toFixed(2) || '--'}</td>
                                        <td>${t.holding_days || '--'}</td>
                                        <td class="${(t.return_pct || 0) >= 0 ? 'positive' : 'negative'}">${t.return_pct ? (t.return_pct * 100).toFixed(2) + '%' : '--'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('detail-trades').innerHTML = '<p style="color: #8b949e; text-align: center;">æ­¤æœŸé–“ç„¡äº¤æ˜“è¨˜éŒ„</p>';
                }

                document.getElementById('monitor-detail').style.display = 'block';
            } catch (e) {
                alert('è¼‰å…¥äº¤æ˜“æ­·å²å¤±æ•—: ' + e.message);
            }
        }

        // é é¢åˆ‡æ›æ™‚æ›´æ–°ç›£æ§æ¸…å–®
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'monitor') {
                    renderMonitorList();
                }
            });
        });

        // åˆå§‹åŒ–
        updateStatus();
        setInterval(updateStatus, 5000);  // æ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡
        loadMonitorList();  // è¼‰å…¥ç›£æ§æ¸…å–®

        // è¨­å®šçµæŸæ—¥æœŸé è¨­ç‚ºä»Šå¤©
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('backtest-end-date').value = today;
        document.getElementById('portfolio-end-date').value = today;
    </script>
</body>

</html>